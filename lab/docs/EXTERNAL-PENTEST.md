# External Penetration Testing Guide

This guide covers performing external penetration tests against targets outside the lab environment.

## External Target Configuration

The external pentest target is configured as:
- **IP Address:** 144.178.248.26
- **Name:** external-target

## Running External Pentests

### Quick Start

```bash
# Run external pentest against default target (144.178.248.26)
cd lab
./scripts/external-pentest.sh

# Or specify a custom IP
./scripts/external-pentest.sh 192.168.1.100
```

### With Traffic Capture

```bash
# Start traffic capture
./scripts/capture.sh start any "external_capture_$(date +%Y%m%d_%H%M%S).pcap"

# Run external pentest
./scripts/external-pentest.sh 144.178.248.26

# Stop capture
./scripts/capture.sh stop

# Analyze captured traffic
./scripts/analyze-pcap.sh ./captures/external_capture_*.pcap
```

## External Pentest Phases

### Phase 1: Network Discovery
- Host discovery (ICMP ping)
- Port scanning (TCP/UDP)
- Service enumeration
- OS fingerprinting

### Phase 2: Vulnerability Scanning
- Nmap vulnerability scripts
- HTTP/HTTPS vulnerability detection
- Service-specific vulnerability checks

### Phase 3: Web Application Testing
- HTTP/HTTPS service detection
- SQL injection testing
- Directory traversal testing
- Information disclosure checks

### Phase 4: Credential Testing
- SSH brute force (if SSH detected)
- Common credential testing
- Default account testing

## Manual External Testing

### From Kali Container

```bash
# Enter Kali container
docker exec -it pentest-kali /bin/bash

# Network discovery
nmap -sn 144.178.248.26
nmap -sS -sV -p- 144.178.248.26

# Vulnerability scanning
nmap --script vuln 144.178.248.26

# Web testing
curl http://144.178.248.26
curl https://144.178.248.26

# SQL injection test
curl "http://144.178.248.26/?id=1' OR '1'='1"

# Directory traversal test
curl "http://144.178.248.26/?file=../etc/passwd"
```

## Traffic Analysis

External pentest traffic can be captured and analyzed:

```bash
# Capture external traffic
./scripts/capture.sh start any "external_144.178.248.26_$(date +%Y%m%d_%H%M%S).pcap"

# Run tests...

# Stop capture
./scripts/capture.sh stop

# Analyze PCAP
./scripts/analyze-pcap.sh ./captures/external_*.pcap ./findings
```

## Generating IDPS Rules from External Pentest

After analyzing external pentest traffic:

```bash
# Analyze PCAP
./scripts/analyze-pcap.sh ./captures/external_*.pcap

# Generate findings report
./scripts/generate-report.sh

# Generate IDPS rules via API
curl -X POST http://localhost:8080/api/pcap/analyze \
  -H "Content-Type: application/json" \
  -d '{"pcap_file": "./lab/captures/external_*.pcap"}'

# Generate rules from findings
curl -X POST http://localhost:8080/api/rules/generate \
  -H "Content-Type: application/json" \
  -d @./lab/findings/findings_*.json
```

## Security Considerations

⚠️ **IMPORTANT:** External penetration testing should only be performed:

1. **With explicit authorization** - Ensure you have written permission to test the target
2. **Within scope** - Only test systems and services you're authorized to test
3. **Responsibly** - Follow responsible disclosure practices
4. **Legally** - Ensure testing complies with local laws and regulations

### Legal Requirements

- Obtain written authorization before testing
- Document authorization and scope
- Follow responsible disclosure practices
- Comply with applicable laws (Computer Fraud and Abuse Act, GDPR, etc.)

## Results and Reporting

External pentest results are saved in:
- **Kali container:** `/root/pentest-results/external_*`
- **PCAP files:** `./lab/captures/external_*.pcap`
- **Findings:** `./lab/findings/external_*.json`
- **Reports:** `./lab/reports/pentest_report_*.html`

## Integration with IDPS

External pentest findings can be used to generate IDPS rules:

1. Capture traffic during external pentest
2. Analyze PCAP files to extract attack patterns
3. Generate vulnerability findings
4. Create Suricata rules from findings
5. Activate rules in IDPS system

This allows the IDPS to detect similar attack patterns in production traffic.

## Example Workflow

```bash
# 1. Start traffic capture
./scripts/capture.sh start any "external_$(date +%Y%m%d_%H%M%S).pcap"

# 2. Run external pentest
./scripts/external-pentest.sh 144.178.248.26

# 3. Stop capture
./scripts/capture.sh stop

# 4. Analyze PCAP
./scripts/analyze-pcap.sh ./captures/external_*.pcap

# 5. Generate report
./scripts/generate-report.sh

# 6. Generate IDPS rules (via API or frontend)
# Access http://localhost:4200/pentest
# Upload PCAP, view findings, generate rules
```

## Troubleshooting

### Cannot reach external target
- Check network connectivity from Kali container
- Verify target IP is correct and accessible
- Check firewall rules

### No results generated
- Ensure Kali container has required tools installed
- Check output directory permissions
- Review container logs: `docker logs pentest-kali`

### Traffic capture not working
- Verify capture container is running: `docker ps | grep capture`
- Check capture script permissions: `chmod +x scripts/capture.sh`
- Verify network access from capture container
