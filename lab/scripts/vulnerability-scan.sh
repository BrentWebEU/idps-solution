#!/bin/bash
# Vulnerability scanning script
# Performs automated vulnerability detection

KALI_CONTAINER="pentest-kali"
OUTPUT_DIR="/root/pentest-results"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Target IPs (adjust based on your lab setup)
TARGETS=(
    "172.21.0.2"  # Web server
    "172.21.0.3"  # RADIUS server
    "172.22.0.3"  # Database server
    "172.22.0.4"  # File server
    "172.22.0.5"  # Vulnerable Linux
)

echo "Starting vulnerability scan..."
echo "Timestamp: $TIMESTAMP"

docker exec $KALI_CONTAINER mkdir -p $OUTPUT_DIR

for target in "${TARGETS[@]}"; do
    echo ""
    echo "Scanning target: $target"
    OUTPUT_FILE="${OUTPUT_DIR}/vuln_scan_${target}_${TIMESTAMP}.xml"
    
    # Nmap vulnerability scan
    echo "  - Running Nmap vulnerability scripts..."
    docker exec $KALI_CONTAINER nmap --script vuln -oX "${OUTPUT_FILE}" $target
    
    # Service-specific scans
    echo "  - Running service-specific scans..."
    
    # HTTP vulnerability scan
    docker exec $KALI_CONTAINER nmap --script http-vuln*,http-enum -p 80,8080 -oX "${OUTPUT_FILE}.http" $target 2>/dev/null || true
    
    # MySQL vulnerability scan
    docker exec $KALI_CONTAINER nmap --script mysql-* -p 3306 -oX "${OUTPUT_FILE}.mysql" $target 2>/dev/null || true
    
    # SSH vulnerability scan
    docker exec $KALI_CONTAINER nmap --script ssh-* -p 22 -oX "${OUTPUT_FILE}.ssh" $target 2>/dev/null || true
    
    echo "  Results saved to: $OUTPUT_FILE*"
done

echo ""
echo "Vulnerability scan complete!"
echo "Results saved in Kali container at: $OUTPUT_DIR"
