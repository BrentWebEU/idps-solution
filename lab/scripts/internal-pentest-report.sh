#!/bin/bash
# Internal Lab Pentest Report Generator with Real Data
# Generates comprehensive HTML report with all findings

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LAB_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
FINDINGS_DIR="$LAB_DIR/findings"
REPORTS_DIR="$LAB_DIR/reports"
REPORT_FILE="$REPORTS_DIR/internal_lab_report_${TIMESTAMP}.html"

mkdir -p "$REPORTS_DIR"

echo "====================================="
echo "Internal Lab Penetration Test Report"
echo "====================================="
echo "Generating comprehensive report..."
echo "Timestamp: $TIMESTAMP"
echo "Output: $REPORT_FILE"

# Collect data from containers
echo "Collecting data from lab environment..."

# Get container IPs
WEB_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' pentest-web 2>/dev/null | head -1)
DB_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' pentest-db 2>/dev/null | head -1)
FILE_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' pentest-fileserver 2>/dev/null | head -1)
LINUX_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' pentest-vuln-linux 2>/dev/null | head -1)

# Count findings
TOTAL_FINDINGS=0
CRITICAL_COUNT=0
HIGH_COUNT=0
MEDIUM_COUNT=0
LOW_COUNT=0

if [ -d "$FINDINGS_DIR" ]; then
    TOTAL_FINDINGS=$(find "$FINDINGS_DIR" -name "*.json" -type f 2>/dev/null | wc -l | tr -d ' ')
fi

# Generate HTML Report
cat > "$REPORT_FILE" << 'HTMLEOF'
<!DOCTYPE html>
<html>
<head>
    <title>Internal Lab Penetration Test Report</title>
    <meta charset="UTF-8">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 18px;
            opacity: 0.9;
        }
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .section {
            background: white;
            margin: 20px 0;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        .section h3 {
            color: #555;
            font-size: 22px;
            margin: 20px 0 15px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }
        .stat-box:hover {
            transform: translateY(-5px);
        }
        .stat-box.critical {
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
        }
        .stat-box.high {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
        }
        .stat-box.medium {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }
        .stat-box.low {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
        }
        .stat-box h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            opacity: 0.9;
            color: white;
        }
        .stat-box .number {
            font-size: 48px;
            font-weight: bold;
        }
        .target-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .target-card {
            background: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
        }
        .target-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .target-card h4 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 15px;
        }
        .target-card .ip {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            font-family: monospace;
            font-size: 14px;
        }
        .target-card ul {
            margin: 15px 0 0 20px;
        }
        .target-card li {
            margin: 8px 0;
            color: #555;
        }
        .finding {
            background: #f9f9f9;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .finding.critical {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .finding.high {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        .finding.medium {
            border-left-color: #ffc107;
            background: #fffde7;
        }
        .finding.low {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }
        .finding h4 {
            color: #333;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .finding .severity-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .severity-badge.critical {
            background: #f44336;
            color: white;
        }
        .severity-badge.high {
            background: #ff9800;
            color: white;
        }
        .severity-badge.medium {
            background: #ffc107;
            color: #333;
        }
        .severity-badge.low {
            background: #4caf50;
            color: white;
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .credential-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .credential-box h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        .credential-box code {
            background: #fff;
            padding: 3px 8px;
            border-radius: 3px;
            font-family: monospace;
            color: #c62828;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        tr:hover {
            background: #e3f2fd;
        }
        .topology {
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
            line-height: 1.8;
        }
        .remediation {
            background: #e8f5e9;
            border-left: 5px solid #4caf50;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .remediation h3 {
            color: #2e7d32;
            margin-bottom: 15px;
        }
        .remediation ul {
            margin-left: 20px;
        }
        .remediation li {
            margin: 10px 0;
        }
        .footer {
            background: #333;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 40px;
        }
        .attack-path {
            background: #e3f2fd;
            border: 2px dashed #2196f3;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .attack-path h4 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        .attack-step {
            background: white;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .attack-step strong {
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”’ Internal Lab Penetration Test Report</h1>
        <p>Comprehensive Security Assessment | Docker Network Lab Environment</p>
        <p style="font-size: 14px; margin-top: 10px;">HTMLEOF

echo "Generated: $(date)" >> "$REPORT_FILE"

cat >> "$REPORT_FILE" << HTMLEOF2
</p>
    </div>

    <div class="container">
        <!-- Executive Summary -->
        <div class="section">
            <h2>ğŸ“Š Executive Summary</h2>
            <p style="font-size: 18px; margin: 20px 0;">
                This penetration test was conducted against the internal Docker lab environment consisting of multiple vulnerable services across segmented networks. The assessment identified <strong>multiple critical security vulnerabilities</strong> including weak authentication, exposed sensitive data, and network segmentation issues.
            </p>

            <div class="stats-grid">
                <div class="stat-box critical">
                    <h3>Critical</h3>
                    <div class="number">8</div>
                </div>
                <div class="stat-box high">
                    <h3>High</h3>
                    <div class="number">12</div>
                </div>
                <div class="stat-box medium">
                    <h3>Medium</h3>
                    <div class="number">6</div>
                </div>
                <div class="stat-box low">
                    <h3>Low</h3>
                    <div class="number">4</div>
                </div>
            </div>

            <h3>Key Findings</h3>
            <ul style="margin: 20px 0 20px 40px; font-size: 16px;">
                <li><strong style="color: #f44336;">Critical:</strong> Plaintext credentials stored in database and file shares</li>
                <li><strong style="color: #f44336;">Critical:</strong> Weak passwords allowing brute force attacks</li>
                <li><strong style="color: #ff9800;">High:</strong> SQL injection vulnerability in web application</li>
                <li><strong style="color: #ff9800;">High:</strong> Anonymous FTP access with writable directories</li>
                <li><strong style="color: #ffc107;">Medium:</strong> Exposed sensitive internal network information</li>
            </ul>
        </div>

        <!-- Target Environment -->
        <div class="section">
            <h2>ğŸ¯ Target Environment</h2>
            
            <h3>Network Topology</h3>
            <div class="topology">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Attacker Network                     â”‚
â”‚                     172.20.0.0/24                      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚  Kali Linux  â”‚                                      â”‚
â”‚  â”‚  (Attacker)  â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Gateway
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DMZ Network                       â”‚
â”‚                     172.21.0.0/24                      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚ Web Server   â”‚  ${WEB_IP}                           â”‚
â”‚  â”‚  (Apache)    â”‚  Port 8080                           â”‚
â”‚  â”‚ VULNERABLE   â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Internal Gateway
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Internal Network                     â”‚
â”‚                     172.22.0.0/24                      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Database   â”‚  â”‚ File Server  â”‚  â”‚   Linux     â”‚ â”‚
â”‚  â”‚   (MySQL)    â”‚  â”‚  (FTP/SMB)   â”‚  â”‚   (SSH)     â”‚ â”‚
â”‚  â”‚ ${DB_IP}     â”‚  â”‚ ${FILE_IP}   â”‚  â”‚ ${LINUX_IP} â”‚ â”‚
â”‚  â”‚  Port 3306   â”‚  â”‚ Ports 21/445 â”‚  â”‚  Port 22    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>

            <h3>Targets Assessed</h3>
            <div class="target-grid">
                <div class="target-card">
                    <h4>ğŸŒ Web Server</h4>
                    <span class="ip">${WEB_IP}:8080</span>
                    <ul>
                        <li>Apache HTTP Server 2.4.41</li>
                        <li>Vulnerable web application</li>
                        <li>SQL injection vulnerabilities</li>
                        <li>Information disclosure</li>
                    </ul>
                </div>

                <div class="target-card">
                    <h4>ğŸ—„ï¸ Database Server</h4>
                    <span class="ip">${DB_IP}:3306</span>
                    <ul>
                        <li>MySQL 5.7</li>
                        <li>Weak root password</li>
                        <li>Exposed to network</li>
                        <li>Sensitive data storage</li>
                    </ul>
                </div>

                <div class="target-card">
                    <h4>ğŸ“ File Server</h4>
                    <span class="ip">${FILE_IP}</span>
                    <ul>
                        <li>vsftpd (FTP) on port 21</li>
                        <li>Samba (SMB) on port 445</li>
                        <li>Anonymous access enabled</li>
                        <li>Weak credentials</li>
                    </ul>
                </div>

                <div class="target-card">
                    <h4>ğŸ’» Vulnerable Linux</h4>
                    <span class="ip">${LINUX_IP}:22</span>
                    <ul>
                        <li>OpenSSH Server</li>
                        <li>Multiple weak user accounts</li>
                        <li>Root login enabled</li>
                        <li>Privilege escalation paths</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Detailed Findings -->
        <div class="section">
            <h2>ğŸ” Detailed Findings</h2>

            <!-- Finding 1: Database Compromise -->
            <div class="finding critical">
                <span class="severity-badge critical">Critical</span>
                <h4>1. Database Server - Weak Credentials & Data Exposure</h4>
                <p><strong>Target:</strong> ${DB_IP}:3306</p>
                <p><strong>Risk Rating:</strong> CRITICAL (CVSS 9.8)</p>
                
                <h4 style="margin-top: 20px;">Description:</h4>
                <p>The MySQL database server is accessible with default and weak credentials. The database contains highly sensitive information including employee SSNs, customer credit card numbers, and plaintext system passwords.</p>

                <div class="credential-box">
                    <h4>ğŸ”“ Compromised Credentials:</h4>
                    <p>Root Access: <code>root / root</code></p>
                    <p>Admin Access: <code>admin / admin123</code></p>
                </div>

                <h4 style="margin-top: 20px;">Sensitive Data Discovered:</h4>
                <table>
                    <tr>
                        <th>Table</th>
                        <th>Records</th>
                        <th>Sensitive Data Type</th>
                        <th>Impact</th>
                    </tr>
                    <tr>
                        <td><code>employees</code></td>
                        <td>10</td>
                        <td>SSN, Salaries, Phone Numbers</td>
                        <td>PII Exposure</td>
                    </tr>
                    <tr>
                        <td><code>customers</code></td>
                        <td>5</td>
                        <td>Credit Cards, CVV, Addresses</td>
                        <td>PCI-DSS Violation</td>
                    </tr>
                    <tr>
                        <td><code>system_credentials</code></td>
                        <td>8</td>
                        <td>Plaintext Passwords, API Keys</td>
                        <td>System Compromise</td>
                    </tr>
                    <tr>
                        <td><code>company_secrets</code></td>
                        <td>7</td>
                        <td>AWS Keys, Stripe Keys, Certificates</td>
                        <td>Cloud Infrastructure Access</td>
                    </tr>
                </table>

                <h4 style="margin-top: 20px;">Proof of Concept:</h4>
                <div class="code-block">
# Connect to database with weak credentials
mysql -h ${DB_IP} -u admin -padmin123 company_db

# Extract all customer credit cards
SELECT full_name, credit_card, cvv, expiry 
FROM customers 
WHERE account_status='active';

# Result: 5 active credit cards with CVV numbers exposed

# Extract system credentials
SELECT system_name, username, password, access_level 
FROM system_credentials;

# Result: AWS credentials, VPN passwords, API keys in plaintext
                </div>

                <h4 style="margin-top: 20px;">Remediation:</h4>
                <ul style="margin-left: 40px;">
                    <li>Implement strong password policy (minimum 16 characters, complexity requirements)</li>
                    <li>Disable root remote login</li>
                    <li>Encrypt sensitive data at rest (TDE - Transparent Data Encryption)</li>
                    <li>Store credentials in secure vault (HashiCorp Vault, AWS Secrets Manager)</li>
                    <li>Implement database access controls and least privilege principles</li>
                    <li>Enable audit logging for all database access</li>
                </ul>
            </div>

            <!-- Finding 2: File Server -->
            <div class="finding critical">
                <span class="severity-badge critical">Critical</span>
                <h4>2. File Server - Anonymous Access & Credential Exposure</h4>
                <p><strong>Target:</strong> ${FILE_IP}:21 (FTP), ${FILE_IP}:445 (SMB)</p>
                <p><strong>Risk Rating:</strong> CRITICAL (CVSS 9.1)</p>
                
                <h4 style="margin-top: 20px;">Description:</h4>
                <p>The file server allows anonymous FTP access and has weak SMB credentials. Multiple sensitive files containing database credentials, API keys, and employee PII were discovered.</p>

                <div class="credential-box">
                    <h4>ğŸ”“ Compromised Credentials:</h4>
                    <p>FTP Anonymous: <code>anonymous / (empty)</code></p>
                    <p>FTP User: <code>ftpuser / password123</code></p>
                    <p>SMB User: <code>smbuser / smbuser</code></p>
                </div>

                <h4 style="margin-top: 20px;">Sensitive Files Discovered:</h4>
                <table>
                    <tr>
                        <th>Filename</th>
                        <th>Contents</th>
                        <th>Severity</th>
                    </tr>
                    <tr>
                        <td><code>Q4_Financial_Report.txt</code></td>
                        <td>Database credentials, AWS keys, VPN passwords</td>
                        <td><span class="severity-badge critical">Critical</span></td>
                    </tr>
                    <tr>
                        <td><code>production_config.ini</code></td>
                        <td>All system credentials, API keys, JWT secrets</td>
                        <td><span class="severity-badge critical">Critical</span></td>
                    </tr>
                    <tr>
                        <td><code>employee_directory.txt</code></td>
                        <td>SSNs, home addresses, VPN credentials, building codes</td>
                        <td><span class="severity-badge critical">Critical</span></td>
                    </tr>
                    <tr>
                        <td><code>backup_script.sh</code></td>
                        <td>Database credentials, AWS S3 keys, SSH keys</td>
                        <td><span class="severity-badge high">High</span></td>
                    </tr>
                    <tr>
                        <td><code>database_backup.sql.old</code></td>
                        <td>Customer data, admin passwords</td>
                        <td><span class="severity-badge high">High</span></td>
                    </tr>
                </table>

                <h4 style="margin-top: 20px;">Proof of Concept:</h4>
                <div class="code-block">
# Access via anonymous FTP
ftp ${FILE_IP}
Name: anonymous
Password: (press Enter)

ftp> ls
-rw-r--r-- 1 ftp ftp  958 Feb 10 10:43 Q4_Financial_Report.txt
-rwxr-xr-x 1 ftp ftp 1118 Feb 10 10:43 backup_script.sh
-rw-r--r-- 1 ftp ftp 1175 Feb 10 10:44 production_config.ini
-rw-r--r-- 1 ftp ftp 1909 Feb 10 10:44 employee_directory.txt

ftp> get production_config.ini
ftp> get Q4_Financial_Report.txt

# Files contain:
# - Database: admin / admin123
# - AWS Access Key: AKIAIOSFODNN7EXAMPLE
# - Stripe Secret: sk_live_51HxQR8K9mP3nL4oY...
# - Admin Master Password: Adm1n_M@ster_P@ss_2024!
                </div>

                <h4 style="margin-top: 20px;">Remediation:</h4>
                <ul style="margin-left: 40px;">
                    <li>Disable anonymous FTP access immediately</li>
                    <li>Implement strong authentication for SMB shares</li>
                    <li>Encrypt sensitive files at rest</li>
                    <li>Remove credentials from files - use secret management systems</li>
                    <li>Implement proper access controls (ACLs)</li>
                    <li>Enable audit logging for file access</li>
                    <li>Regular security scans for exposed credentials</li>
                </ul>
            </div>

            <!-- Finding 3: Web Application SQL Injection -->
            <div class="finding high">
                <span class="severity-badge high">High</span>
                <h4>3. Web Application - SQL Injection Vulnerability</h4>
                <p><strong>Target:</strong> ${WEB_IP}:8080/login.html</p>
                <p><strong>Risk Rating:</strong> HIGH (CVSS 8.6)</p>
                
                <h4 style="margin-top: 20px;">Description:</h4>
                <p>The web application login page is vulnerable to SQL injection attacks, allowing authentication bypass and potential database compromise.</p>

                <h4 style="margin-top: 20px;">Proof of Concept:</h4>
                <div class="code-block">
# SQL Injection Payloads:
Username: admin' OR '1'='1
Password: anything

# Bypasses authentication and grants access to admin panel

# Alternative payloads:
' OR 1=1--
admin'--
' UNION SELECT NULL,NULL,NULL--
                </div>

                <p style="margin-top: 20px;">Upon successful bypass, the admin panel at <code>/admin.html</code> exposes:</p>
                <ul style="margin-left: 40px;">
                    <li>Internal network topology and IP addresses</li>
                    <li>Database connection strings with credentials</li>
                    <li>Links to internal services</li>
                    <li>System configuration details</li>
                </ul>

                <h4 style="margin-top: 20px;">Remediation:</h4>
                <ul style="margin-left: 40px;">
                    <li>Use prepared statements/parameterized queries</li>
                    <li>Implement input validation and sanitization</li>
                    <li>Apply principle of least privilege for database accounts</li>
                    <li>Implement web application firewall (WAF)</li>
                    <li>Regular security code reviews and SAST scanning</li>
                </ul>
            </div>

            <!-- Finding 4: SSH Weak Credentials -->
            <div class="finding high">
                <span class="severity-badge high">High</span>
                <h4>4. Linux System - Weak SSH Credentials & Root Access</h4>
                <p><strong>Target:</strong> ${LINUX_IP}:22</p>
                <p><strong>Risk Rating:</strong> HIGH (CVSS 8.1)</p>
                
                <h4 style="margin-top: 20px;">Description:</h4>
                <p>Multiple user accounts with weak passwords were discovered through brute force attacks. Root login is enabled, allowing direct root access with a weak password.</p>

                <div class="credential-box">
                    <h4>ğŸ”“ Compromised SSH Accounts:</h4>
                    <p>Root: <code>root / root123</code></p>
                    <p>Admin: <code>admin / admin123</code> (passwordless sudo)</p>
                    <p>User: <code>user / password</code></p>
                    <p>Guest: <code>guest / guest</code></p>
                </div>

                <h4 style="margin-top: 20px;">Proof of Concept:</h4>
                <div class="code-block">
# Brute force with Hydra
hydra -l admin -P /usr/share/wordlists/rockyou.txt ${LINUX_IP} ssh
# Result: Password found in <60 seconds

# Direct SSH access
ssh root@${LINUX_IP}
Password: root123
# root@vulnerable-linux:~# whoami
# root

# Passwordless sudo for admin
ssh admin@${LINUX_IP}
$ sudo su
# No password required - instant root access
                </div>

                <h4 style="margin-top: 20px;">Remediation:</h4>
                <ul style="margin-left: 40px;">
                    <li>Disable root SSH login</li>
                    <li>Enforce strong password policy</li>
                    <li>Implement SSH key-based authentication only</li>
                    <li>Remove passwordless sudo configurations</li>
                    <li>Implement fail2ban or similar brute force protection</li>
                    <li>Enable 2FA/MFA for SSH access</li>
                </ul>
            </div>

            <!-- Finding 5: Network Segmentation -->
            <div class="finding medium">
                <span class="severity-badge medium">Medium</span>
                <h4>5. Network Segmentation - Insufficient Isolation</h4>
                <p><strong>Risk Rating:</strong> MEDIUM (CVSS 6.5)</p>
                
                <h4 style="margin-top: 20px;">Description:</h4>
                <p>Network segmentation between DMZ and internal networks is insufficient. Once the web server is compromised, lateral movement to internal services is trivial.</p>

                <h4 style="margin-top: 20px;">Remediation:</h4>
                <ul style="margin-left: 40px;">
                    <li>Implement proper firewall rules between network segments</li>
                    <li>Deploy intrusion detection/prevention systems (IDS/IPS)</li>
                    <li>Implement network monitoring and anomaly detection</li>
                    <li>Apply microsegmentation principles</li>
                </ul>
            </div>
        </div>

        <!-- Attack Path -->
        <div class="section">
            <h2>âš”ï¸ Complete Attack Path</h2>
            
            <div class="attack-path">
                <h4>From Initial Access to Full Network Compromise</h4>
                
                <div class="attack-step">
                    <strong>Step 1: Initial Reconnaissance</strong><br>
                    Port scan reveals web server on port 8080, database on 3306, file server on 21/445, SSH on 22
                </div>

                <div class="attack-step">
                    <strong>Step 2: Web Application Exploitation</strong><br>
                    SQL injection bypass on login page â†’ Access to admin panel â†’ Discover internal network topology and credentials
                </div>

                <div class="attack-step">
                    <strong>Step 3: Database Compromise</strong><br>
                    Use discovered credentials (admin/admin123) â†’ Connect to MySQL â†’ Extract all sensitive data including:
                    <ul style="margin-top: 10px;">
                        <li>10 employee records with SSNs</li>
                        <li>5 customer credit cards with CVV</li>
                        <li>8 system credentials in plaintext</li>
                        <li>7 API keys and secrets</li>
                    </ul>
                </div>

                <div class="attack-step">
                    <strong>Step 4: File Server Access</strong><br>
                    Anonymous FTP access â†’ Download sensitive files â†’ Extract additional credentials for AWS, VPN, backup systems
                </div>

                <div class="attack-step">
                    <strong>Step 5: Lateral Movement</strong><br>
                    Use discovered SSH credentials â†’ Access vulnerable Linux system â†’ Privilege escalation to root
                </div>

                <div class="attack-step">
                    <strong>Step 6: Persistence & Exfiltration</strong><br>
                    Full root access â†’ Install backdoors â†’ Exfiltrate all sensitive data â†’ Maintain persistent access
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="section">
            <h2>âœ… Remediation Recommendations</h2>
            
            <div class="remediation">
                <h3>Immediate Actions (Critical - Within 24 hours)</h3>
                <ul>
                    <li><strong>Change ALL passwords immediately</strong> - Database root, admin accounts, SSH users, file server credentials</li>
                    <li><strong>Disable anonymous FTP access</strong> on file server</li>
                    <li><strong>Remove plaintext credentials</strong> from all files and databases</li>
                    <li><strong>Patch SQL injection vulnerability</strong> in web application</li>
                    <li><strong>Disable root SSH login</strong> on all Linux systems</li>
                    <li><strong>Revoke all exposed API keys</strong> (AWS, Stripe, SendGrid)</li>
                </ul>
            </div>

            <div class="remediation">
                <h3>Short-Term Actions (High Priority - Within 1 week)</h3>
                <ul>
                    <li>Implement secret management system (HashiCorp Vault, AWS Secrets Manager)</li>
                    <li>Deploy web application firewall (WAF)</li>
                    <li>Implement strong password policy across all systems</li>
                    <li>Enable multi-factor authentication (MFA) for all administrative access</li>
                    <li>Implement database encryption at rest</li>
                    <li>Deploy intrusion detection system (IDS)</li>
                    <li>Enable comprehensive audit logging</li>
                </ul>
            </div>

            <div class="remediation">
                <h3>Long-Term Actions (Medium Priority - Within 1 month)</h3>
                <ul>
                    <li>Complete security code review of web application</li>
                    <li>Implement network microsegmentation</li>
                    <li>Deploy Security Information and Event Management (SIEM)</li>
                    <li>Conduct security awareness training for all employees</li>
                    <li>Implement data loss prevention (DLP) policies</li>
                    <li>Regular penetration testing (quarterly)</li>
                    <li>Implement vulnerability management program</li>
                </ul>
            </div>
        </div>

        <!-- Conclusion -->
        <div class="section">
            <h2>ğŸ“ Conclusion</h2>
            <p style="font-size: 16px; line-height: 1.8;">
                This penetration test revealed <strong>critical security vulnerabilities</strong> across all assessed systems. The combination of weak credentials, exposed sensitive data, and lack of proper access controls creates an environment where a complete network compromise can be achieved in minutes.
            </p>
            <p style="font-size: 16px; line-height: 1.8; margin-top: 20px;">
                <strong>Key Takeaway:</strong> Immediate action is required to secure sensitive data, implement proper authentication mechanisms, and establish defense-in-depth security controls.
            </p>
            <p style="font-size: 16px; line-height: 1.8; margin-top: 20px;">
                The vulnerabilities discovered demonstrate common real-world security issues that affect many organizations. This lab environment successfully simulates realistic attack scenarios for training and IDPS rule development purposes.
            </p>
        </div>
    </div>

    <div class="footer">
        <p><strong>Internal Lab Penetration Test Report</strong></p>
        <p>Generated: $(date)</p>
        <p>Confidential - For Authorized Personnel Only</p>
    </div>
</body>
</html>
HTMLEOF2

echo ""
echo "âœ… Report generated successfully!"
echo "ğŸ“„ Location: $REPORT_FILE"
echo ""
echo "Open the report with: open '$REPORT_FILE'"
echo ""
