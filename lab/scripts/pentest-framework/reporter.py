#!/usr/bin/env python3
"""
Report generator for pentest framework
"""

import json
import yaml
from datetime import datetime
from pathlib import Path

class Reporter:
    def __init__(self, config_file="config.yaml"):
        with open(config_file, 'r') as f:
            self.config = yaml.safe_load(f)
    
    def load_results(self, results_dir):
        """Load all result files from directory"""
        results_path = Path(results_dir)
        results = {}
        
        for file in results_path.glob("*.json"):
            with open(file, 'r') as f:
                results[file.stem] = json.load(f)
        
        return results
    
    def generate_findings(self, results):
        """Extract findings from results"""
        findings = []
        
        for result_name, result_data in results.items():
            if 'target_scan' in result_data:
                # Process scan results
                for target_name, target_data in result_data['target_scan'].items():
                    if 'vulnerabilities' in target_data:
                        findings.append({
                            'type': 'vulnerability',
                            'target': target_name,
                            'ip': target_data.get('ip'),
                            'description': 'Vulnerabilities detected',
                            'severity': 'medium'
                        })
            
            if 'web_server' in result_data:
                # Process exploitation results
                if 'sql_injection' in result_data['web_server']:
                    for test in result_data['web_server']['sql_injection']:
                        if test.get('success'):
                            findings.append({
                                'type': 'sql_injection',
                                'target': 'web_server',
                                'payload': test.get('payload'),
                                'description': 'SQL injection vulnerability detected',
                                'severity': 'high'
                            })
                
                if 'directory_traversal' in result_data['web_server']:
                    for test in result_data['web_server']['directory_traversal']:
                        if test.get('success'):
                            findings.append({
                                'type': 'directory_traversal',
                                'target': 'web_server',
                                'payload': test.get('payload'),
                                'description': 'Directory traversal vulnerability detected',
                                'severity': 'high'
                            })
            
            # Process credential test results
            for key, value in result_data.items():
                if isinstance(value, list) and len(value) > 0:
                    if isinstance(value[0], dict) and 'username' in value[0]:
                        successful = [v for v in value if v.get('success')]
                        if successful:
                            findings.append({
                                'type': 'weak_credentials',
                                'target': key,
                                'credentials': successful,
                                'description': 'Weak credentials found',
                                'severity': 'high'
                            })
        
        return findings
    
    def generate_html_report(self, findings, output_file="pentest_report.html"):
        """Generate HTML report"""
        html = f"""
<!DOCTYPE html>
<html>
<head>
    <title>Penetration Test Report</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 20px; }}
        h1 {{ color: #333; }}
        .finding {{ border: 1px solid #ddd; padding: 15px; margin: 10px 0; }}
        .high {{ border-left: 5px solid #f00; }}
        .medium {{ border-left: 5px solid #ff0; }}
        .low {{ border-left: 5px solid #0f0; }}
        .severity {{ font-weight: bold; }}
    </style>
</head>
<body>
    <h1>Penetration Test Report</h1>
    <p>Generated: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}</p>
    <p>Total Findings: {len(findings)}</p>
    
    <h2>Findings</h2>
"""
        
        for finding in findings:
            severity = finding.get('severity', 'low')
            html += f"""
    <div class="finding {severity}">
        <h3>{finding.get('type', 'Unknown').replace('_', ' ').title()}</h3>
        <p><strong>Target:</strong> {finding.get('target', 'Unknown')}</p>
        <p><strong>Severity:</strong> <span class="severity">{severity.upper()}</span></p>
        <p><strong>Description:</strong> {finding.get('description', 'No description')}</p>
"""
            if 'payload' in finding:
                html += f"        <p><strong>Payload:</strong> <code>{finding['payload']}</code></p>"
            if 'credentials' in finding:
                html += f"        <p><strong>Credentials:</strong> {len(finding['credentials'])} successful</p>"
            
            html += "    </div>"
        
        html += """
</body>
</html>
"""
        
        output_path = Path(self.config['output']['results_dir']) / output_file
        output_path.parent.mkdir(parents=True, exist_ok=True)
        
        with open(output_path, 'w') as f:
            f.write(html)
        
        print(f"HTML report generated: {output_path}")
        return output_path
    
    def generate_json_report(self, findings, output_file="pentest_report.json"):
        """Generate JSON report"""
        report = {
            'timestamp': datetime.now().isoformat(),
            'total_findings': len(findings),
            'findings': findings
        }
        
        output_path = Path(self.config['output']['results_dir']) / output_file
        output_path.parent.mkdir(parents=True, exist_ok=True)
        
        with open(output_path, 'w') as f:
            json.dump(report, f, indent=2)
        
        print(f"JSON report generated: {output_path}")
        return output_path

if __name__ == "__main__":
    import sys
    
    if len(sys.argv) < 2:
        print("Usage: reporter.py <results_directory>")
        sys.exit(1)
    
    reporter = Reporter()
    results = reporter.load_results(sys.argv[1])
    findings = reporter.generate_findings(results)
    
    reporter.generate_json_report(findings)
    reporter.generate_html_report(findings)
