#!/usr/bin/env python3
"""
Network and service scanner for pentest framework
"""

import subprocess
import json
import yaml
import sys
from datetime import datetime
from pathlib import Path

class NetworkScanner:
    def __init__(self, config_file="config.yaml"):
        with open(config_file, 'r') as f:
            self.config = yaml.safe_load(f)
        self.results = []
        self.timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    
    def scan_network(self, network):
        """Perform network discovery scan"""
        print(f"Scanning network: {network}")
        cmd = ["nmap", "-sn", network]
        result = subprocess.run(cmd, capture_output=True, text=True)
        return result.stdout
    
    def scan_ports(self, target, ports=None):
        """Perform port scan on target"""
        print(f"Scanning ports on {target}")
        if ports:
            cmd = ["nmap", "-sS", "-sV", "-p", ports, target]
        else:
            cmd = ["nmap", "-sS", "-sV", "-p-", target]
        result = subprocess.run(cmd, capture_output=True, text=True)
        return result.stdout
    
    def scan_vulnerabilities(self, target):
        """Scan for vulnerabilities"""
        print(f"Scanning vulnerabilities on {target}")
        cmd = ["nmap", "--script", "vuln", target]
        result = subprocess.run(cmd, capture_output=True, text=True)
        return result.stdout
    
    def scan_all_networks(self):
        """Scan all configured networks"""
        networks = [
            self.config['networks']['attacker'],
            self.config['networks']['dmz'],
            self.config['networks']['internal']
        ]
        
        results = {}
        for network in networks:
            results[network] = {
                'host_discovery': self.scan_network(network),
                'timestamp': self.timestamp
            }
        
        # Scan external targets if configured
        if 'external_targets' in self.config:
            results['external_targets'] = {}
            for target in self.config['external_targets']:
                ip = target['ip']
                print(f"\nScanning external target: {ip}")
                results['external_targets'][ip] = {
                    'ports': self.scan_ports(ip),
                    'vulnerabilities': self.scan_vulnerabilities(ip),
                    'timestamp': self.timestamp
                }
        
        return results
    
    def scan_targets(self):
        """Scan all configured targets"""
        results = {}
        for target_name, target_config in self.config['targets'].items():
            ip = target_config['ip']
            print(f"\nScanning target: {target_name} ({ip})")
            
            results[target_name] = {
                'ip': ip,
                'ports': self.scan_ports(ip),
                'vulnerabilities': self.scan_vulnerabilities(ip),
                'timestamp': self.timestamp
            }
        
        return results
    
    def save_results(self, results, filename=None):
        """Save scan results to JSON file"""
        if filename is None:
            filename = f"scan_results_{self.timestamp}.json"
        
        output_dir = Path(self.config['output']['results_dir'])
        output_dir.mkdir(parents=True, exist_ok=True)
        
        filepath = output_dir / filename
        with open(filepath, 'w') as f:
            json.dump(results, f, indent=2)
        
        print(f"\nResults saved to: {filepath}")
        return filepath

if __name__ == "__main__":
    scanner = NetworkScanner()
    
    print("Starting network scan...")
    network_results = scanner.scan_all_networks()
    
    print("\nStarting target scan...")
    target_results = scanner.scan_targets()
    
    all_results = {
        'network_scan': network_results,
        'target_scan': target_results
    }
    
    scanner.save_results(all_results)
