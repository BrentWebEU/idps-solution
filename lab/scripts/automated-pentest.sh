#!/bin/bash
# Main automated pentest orchestration script
# Coordinates all automated pentest activities

KALI_CONTAINER="pentest-kali"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "=========================================="
echo "Automated Penetration Test"
echo "Timestamp: $TIMESTAMP"
echo "=========================================="
echo ""

# Ensure Kali container has required tools
echo "Installing required tools in Kali container..."
docker exec $KALI_CONTAINER sh -c "apt-get update -qq && apt-get install -y -qq nmap hydra sshpass mysql-client ftp freeradius-utils curl tcpdump 2>&1 | grep -v '^WARNING' || true"

# Check if capture is running
echo "Checking traffic capture status..."
if docker exec pentest-capture sh -c "pgrep tcpdump" > /dev/null 2>&1; then
    echo "  Traffic capture is running"
else
    echo "  WARNING: Traffic capture is not running"
    echo "  Start capture with: ./scripts/capture.sh start"
    read -p "  Continue anyway? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Run network discovery
echo ""
echo "Phase 1: Network Discovery"
echo "---------------------------"
bash "$SCRIPT_DIR/network-discovery.sh"

# Run vulnerability scanning
echo ""
echo "Phase 2: Vulnerability Scanning"
echo "---------------------------------"
bash "$SCRIPT_DIR/vulnerability-scan.sh"

# Run credential testing
echo ""
echo "Phase 3: Credential Testing"
echo "----------------------------"
bash "$SCRIPT_DIR/credential-testing.sh"

# Run exploitation attempts
echo ""
echo "Phase 4: Exploitation Attempts"
echo "-------------------------------"
bash "$SCRIPT_DIR/exploitation.sh"

echo ""
echo "=========================================="
echo "Automated pentest complete!"
echo "Results saved in Kali container at: /root/pentest-results"
echo "=========================================="
echo ""
echo "Next steps:"
echo "1. Review results: docker exec -it $KALI_CONTAINER ls -la /root/pentest-results"
echo "2. Stop traffic capture: ./scripts/capture.sh stop"
echo "3. Analyze PCAP files: ./scripts/analyze-pcap.sh"
echo "4. Generate report: ./scripts/generate-report.sh"
