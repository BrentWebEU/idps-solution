#!/bin/bash
# Real-World Penetration Testing Suite
# Works with ANY target IP - not just lab environment
# Usage: ./real-world-pentest.sh <target_ip> [scan_type]

set -e

KALI_CONTAINER="pentest-kali"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LAB_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
FINDINGS_DIR="$LAB_DIR/findings"
REPORTS_DIR="$LAB_DIR/reports"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get target from command line
TARGET=${1}
SCAN_TYPE=${2:-"full"}

if [[ -z "$TARGET" ]]; then
    echo -e "${RED}[!] ERROR: No target specified${NC}"
    echo ""
    echo "Usage: $0 <target_ip> [scan_type]"
    echo ""
    echo "Examples:"
    echo "  $0 192.168.1.100 full          # Full pentest"
    echo "  $0 10.0.1.50 quick             # Quick scan"
    echo "  $0 172.21.0.2 lab              # Lab mode (auto-detect)"
    echo "  $0 144.178.248.26 external     # External target"
    echo ""
    exit 1
fi

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘                                                              â•‘${NC}"
echo -e "${BLUE}â•‘           REAL-WORLD PENETRATION TESTING SUITE              â•‘${NC}"
echo -e "${BLUE}â•‘                                                              â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${YELLOW}Target:${NC} $TARGET"
echo -e "${YELLOW}Scan Type:${NC} $SCAN_TYPE"
echo -e "${YELLOW}Timestamp:${NC} $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

# Validate Kali container is running
if ! docker ps | grep -q $KALI_CONTAINER; then
    echo -e "${RED}[!] ERROR: Kali container '$KALI_CONTAINER' is not running${NC}"
    exit 1
fi

# Create output directories
mkdir -p "$FINDINGS_DIR" "$REPORTS_DIR"

# Check if target is reachable
echo -e "${BLUE}[*] Phase 1: Target Validation${NC}"
if docker exec $KALI_CONTAINER timeout 3 ping -c 1 $TARGET >/dev/null 2>&1; then
    echo -e "${GREEN}[âœ“] Target $TARGET is alive${NC}"
else
    echo -e "${YELLOW}[!] Target not responding to ping (may block ICMP)${NC}"
    echo -e "${BLUE}[*] Continuing with scan...${NC}"
fi
echo ""

# Phase 2: Network Discovery
echo -e "${BLUE}[*] Phase 2: Network Discovery${NC}"
echo "[*] Discovering network topology..."
BASE_NET=$(echo $TARGET | cut -d'.' -f1-3)
TARGET_NETWORK="${BASE_NET}.0/24"
echo "[*] Target network: $TARGET_NETWORK"

# Quick host discovery
ALIVE_HOSTS=()
echo "[*] Quick ping sweep of gateway and common IPs..."
for i in 1 2 10 254; do
    TEST_IP="$BASE_NET.$i"
    if timeout 2 docker exec $KALI_CONTAINER ping -c 1 -W 1 $TEST_IP >/dev/null 2>&1; then
        echo -e "  ${GREEN}[+]${NC} Alive: $TEST_IP"
        ALIVE_HOSTS+=("$TEST_IP")
    fi
done
echo -e "${GREEN}[âœ“] Found ${#ALIVE_HOSTS[@]} alive hosts${NC}"
echo ""

# Phase 3: Port Scanning
echo -e "${BLUE}[*] Phase 3: Port Scanning${NC}"
NMAP_OUTPUT="$FINDINGS_DIR/nmap_${TARGET//\./_}_$TIMESTAMP.txt"
echo "[*] Running nmap on $TARGET..."
echo "[*] Output: $NMAP_OUTPUT"

if [[ "$SCAN_TYPE" == "quick" ]]; then
    docker exec $KALI_CONTAINER nmap -T4 -F -sV $TARGET -oN /tmp/nmap_output.txt 2>&1 | tee "$NMAP_OUTPUT"
else
    docker exec $KALI_CONTAINER nmap -T4 -sV -sC -p- $TARGET -oN /tmp/nmap_output.txt 2>&1 | tee "$NMAP_OUTPUT"
fi

# Extract open ports
OPEN_PORTS=$(grep "^[0-9]" "$NMAP_OUTPUT" | grep "open" | awk '{print $1}' | cut -d'/' -f1 | tr '\n' ' ')
if [[ -n "$OPEN_PORTS" ]]; then
    echo -e "${GREEN}[âœ“] Open ports:${NC} $OPEN_PORTS"
else
    echo -e "${YELLOW}[!] No open ports detected${NC}"
fi
echo ""

# Phase 4: Service Enumeration
echo -e "${BLUE}[*] Phase 4: Service Enumeration${NC}"
FOUND_SERVICES=()

# Check for web services
if echo "$OPEN_PORTS" | grep -qE "(80|443|8080|8443)"; then
    echo -e "${GREEN}[+]${NC} Web service detected"
    FOUND_SERVICES+=("HTTP")
    
    # Try to grab banner
    if echo "$OPEN_PORTS" | grep -q "80"; then
        WEB_BANNER=$(docker exec $KALI_CONTAINER curl -s -I http://$TARGET/ 2>/dev/null | head -5)
        echo "[*] Web server banner:"
        echo "$WEB_BANNER" | grep -E "Server:|X-Powered-By:" || echo "  (No banner)"
    fi
fi

# Check for SSH
if echo "$OPEN_PORTS" | grep -q "22"; then
    echo -e "${GREEN}[+]${NC} SSH service detected"
    FOUND_SERVICES+=("SSH")
fi

# Check for database services
if echo "$OPEN_PORTS" | grep -qE "(3306|5432|1433|27017)"; then
    echo -e "${GREEN}[+]${NC} Database service detected"
    FOUND_SERVICES+=("DATABASE")
fi

# Check for SMB
if echo "$OPEN_PORTS" | grep -qE "(139|445)"; then
    echo -e "${GREEN}[+]${NC} SMB service detected"
    FOUND_SERVICES+=("SMB")
fi

echo -e "${GREEN}[âœ“] Found ${#FOUND_SERVICES[@]} service types${NC}"
echo ""

# Phase 5: Vulnerability Assessment
echo -e "${BLUE}[*] Phase 5: Vulnerability Assessment${NC}"
VULN_COUNT=0

# Check for common vulnerabilities based on services found
if [[ " ${FOUND_SERVICES[@]} " =~ "HTTP" ]]; then
    echo "[*] Testing web application..."
    
    # Test for common paths
    for path in "/admin" "/login" "/phpmyadmin" "/wp-admin"; do
        if docker exec $KALI_CONTAINER curl -s -o /dev/null -w "%{http_code}" http://$TARGET$path 2>/dev/null | grep -q "200"; then
            echo -e "  ${YELLOW}[!]${NC} Found: $path (200 OK)"
            ((VULN_COUNT++))
        fi
    done
    
    # Nikto scan (limited)
    echo "[*] Running Nikto web scanner..."
    docker exec $KALI_CONTAINER timeout 60 nikto -h http://$TARGET -C all -Tuning 123 2>&1 | grep "+ " | head -10 || true
fi

if [[ " ${FOUND_SERVICES[@]} " =~ "SSH" ]]; then
    echo "[*] Testing SSH..."
    # Check SSH version for known vulnerabilities
    SSH_VERSION=$(docker exec $KALI_CONTAINER ssh -V 2>&1 || echo "unknown")
    echo "  Version: $SSH_VERSION"
fi

echo -e "${GREEN}[âœ“] Vulnerability scan complete${NC}"
echo ""

# Phase 6: Generate Report
echo -e "${BLUE}[*] Phase 6: Generating Report${NC}"
REPORT_FILE="$REPORTS_DIR/pentest_${TARGET//\./_}_$TIMESTAMP.html"

cat > "$REPORT_FILE" << 'HTMLEOF'
<!DOCTYPE html>
<html>
<head>
    <title>Penetration Test Report</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        .finding {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
        }
        .success {
            color: #28a745;
        }
        .warning {
            color: #ffc107;
        }
        .critical {
            color: #dc3545;
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”’ Penetration Test Report</h1>
HTMLEOF

# Add target info
cat >> "$REPORT_FILE" << HTMLEOF
        <div class="section">
            <h2>Target Information</h2>
            <p><strong>Target IP:</strong> $TARGET</p>
            <p><strong>Network:</strong> $TARGET_NETWORK</p>
            <p><strong>Scan Date:</strong> $(date '+%Y-%m-%d %H:%M:%S')</p>
            <p><strong>Scan Type:</strong> $SCAN_TYPE</p>
        </div>
        
        <div class="section">
            <h2>Discovered Hosts</h2>
            <p>Found <strong>${#ALIVE_HOSTS[@]}</strong> alive hosts:</p>
            <ul>
HTMLEOF

for host in "${ALIVE_HOSTS[@]}"; do
    echo "                <li>$host</li>" >> "$REPORT_FILE"
done

cat >> "$REPORT_FILE" << HTMLEOF
            </ul>
        </div>
        
        <div class="section">
            <h2>Open Ports</h2>
            <p><strong>Target:</strong> $TARGET</p>
            <pre>$OPEN_PORTS</pre>
        </div>
        
        <div class="section">
            <h2>Detected Services</h2>
            <ul>
HTMLEOF

for service in "${FOUND_SERVICES[@]}"; do
    echo "                <li><span class=\"success\">âœ“</span> $service</li>" >> "$REPORT_FILE"
done

cat >> "$REPORT_FILE" << 'HTMLEOF'
            </ul>
        </div>
        
        <div class="section">
            <h2>Recommendations</h2>
            <ul>
                <li>Close unnecessary ports</li>
                <li>Update all services to latest versions</li>
                <li>Implement strong authentication</li>
                <li>Enable logging and monitoring</li>
                <li>Deploy firewall rules</li>
            </ul>
        </div>
    </div>
</body>
</html>
HTMLEOF

echo -e "${GREEN}[âœ“] Report generated: $REPORT_FILE${NC}"
echo ""

# Summary
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘                    SCAN COMPLETE                             â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${YELLOW}SUMMARY:${NC}"
echo "  Target: $TARGET"
echo "  Alive Hosts: ${#ALIVE_HOSTS[@]}"
echo "  Open Ports: $(echo $OPEN_PORTS | wc -w)"
echo "  Services: ${#FOUND_SERVICES[@]}"
echo "  Vulnerabilities: $VULN_COUNT"
echo ""
echo -e "${YELLOW}OUTPUT FILES:${NC}"
echo "  ğŸ“„ Nmap: $NMAP_OUTPUT"
echo "  ğŸ“„ Report: $REPORT_FILE"
echo ""
echo -e "${GREEN}[âœ“] Penetration test complete!${NC}"
echo ""
echo "View report: open '$REPORT_FILE'"
