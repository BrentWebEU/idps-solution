#!/bin/bash
# This script orchestrates various pentesting tools and generates an HTML report.

echo "Automated Pentest Suite - Starting..."

# Define the reports directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LAB_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
REPORTS_DIR="$LAB_DIR/reports"

TARGET_OS=""

# Function to display usage
usage() {
    echo "Usage: $0 <target_os>"
    echo "  <target_os>: Specify the target operating system (linux, windows, mac)"
    exit 1
}

# Parse command-line arguments
if [ -z "$1" ]; then
    usage
fi

TARGET_OS=$(echo "$1" | tr '[:upper:]' '[:lower:]') # Convert to lowercase

# Validate target OS
case "$TARGET_OS" in
    linux|windows|mac)
        echo "Target OS set to: $TARGET_OS"
        ;;
    *)
        echo "Error: Invalid target OS specified. Supported: linux, windows, mac."
        usage
        ;;
esac

# Function to run OS-specific pentesting
run_os_specific_pentest() {
    local os=$1
    echo "Running OS-specific pentest for: $os"

    echo "--- Starting Brute Force Attack ---"
    ./scripts/brute-force-attack.sh -t "$os" # Assuming it can take -t for target OS
    echo "--- Brute Force Attack Finished ---"

    echo "--- Starting Credential Testing ---"
    ./scripts/credential-testing.sh -t "$os" # Assuming it can take -t for target OS
    echo "--- Credential Testing Finished ---"

    case "$os" in
        linux)
            echo "Executing Linux-specific attacks..."
            ./scripts/exploitation.sh -t linux # Assuming exploitation.sh handles target OS
            ./scripts/network-infiltration.sh -t linux # Assuming network-infiltration.sh handles target OS
            ;;
        windows)
            echo "Executing Windows-specific attacks..."
            ./scripts/exploitation.sh -t windows
            ./scripts/network-infiltration.sh -t windows
            # Add more Windows-specific tools/scripts if they exist or are created
            ;;
        mac)
            echo "Executing Mac-specific attacks..."
            # For now, Mac-specific attacks are placeholders as there are no obvious scripts.
            # If specific Mac-targeting scripts are added later, they would go here.
            ;;
    esac
}

# Main pentest flow
run_pentest_flow() {
    local os=$1
    echo "--- Starting Network Discovery ---"
    ./scripts/network-discovery.sh
    echo "--- Network Discovery Finished ---"

    echo "--- Starting Vulnerability Scan ---"
    ./scripts/vulnerability-scan.sh
    echo "--- Vulnerability Scan Finished ---"

    echo "--- Parsing Nmap Results to Findings ---"
    ./scripts/parse-nmap-to-findings.sh
    echo "--- Nmap Results Parsing Finished ---"

    run_os_specific_pentest "$os"

    echo "--- Generating HTML Report ---"
    # Generate markdown summary first
    local markdown_report="$REPORTS_DIR/vulnerability_summary_$(date +%Y%m%d_%H%M%S).md"
    ./scripts/generate-vulnerability-summary.sh "$markdown_report"

    # Convert markdown to HTML using pandoc
    local html_report="${markdown_report%.md}.html"
    if command -v pandoc &> /dev/null
    then
        pandoc -s -c "https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.1.0/github-markdown.min.css" "$markdown_report" -o "$html_report"
        echo "HTML Report Generated: $html_report"
    else
        echo "Warning: pandoc not found. HTML report not generated. Install pandoc for HTML output."
        echo "Markdown Report Generated: $markdown_report"
    fi
    echo "--- HTML Report Generation Finished ---"
}

# Execute the pentest flow
run_pentest_flow "$TARGET_OS"

echo "Automated Pentest Suite - Finished."
