#!/bin/bash
# Complete workflow for external pentest
# Usage: ./run-external-pentest.sh <ip-address>

TARGET_IP=${1:-"144.178.248.26"}

if [ -z "$1" ]; then
    echo "Usage: $0 <ip-address>"
    echo "Example: $0 94.130.75.252"
    exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LAB_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "=========================================="
echo "External Penetration Test Workflow"
echo "Target: $TARGET_IP"
echo "Timestamp: $TIMESTAMP"
echo "=========================================="
echo ""

# Check if lab is running
echo "Checking lab environment..."
if ! docker ps | grep -q "pentest-kali"; then
    echo "ERROR: Lab environment not running."
    echo "Please start with: cd $LAB_DIR && docker-compose up -d"
    exit 1
fi
echo "✓ Lab environment is running"
echo ""

# Step 1: Start traffic capture
echo "Step 1: Starting traffic capture..."
CAPTURE_FILE="external_${TARGET_IP//\./_}_${TIMESTAMP}.pcap"
bash "$SCRIPT_DIR/capture.sh" start any "$CAPTURE_FILE"
if [ $? -eq 0 ]; then
    echo "✓ Traffic capture started: $CAPTURE_FILE"
else
    echo "⚠ Warning: Failed to start traffic capture (may already be running)"
fi
echo ""

# Step 2: Run external pentest
echo "Step 2: Running external penetration test..."
echo "This may take several minutes..."
bash "$SCRIPT_DIR/external-pentest.sh" "$TARGET_IP"
PENTEST_EXIT_CODE=$?

if [ $PENTEST_EXIT_CODE -eq 0 ]; then
    echo "✓ External pentest completed successfully"
else
    echo "⚠ Warning: Pentest completed with errors (exit code: $PENTEST_EXIT_CODE)"
fi
echo ""

# Step 3: Stop capture
echo "Step 3: Stopping traffic capture..."
bash "$SCRIPT_DIR/capture.sh" stop
if [ $? -eq 0 ]; then
    echo "✓ Traffic capture stopped"
else
    echo "⚠ Warning: Failed to stop capture (may not be running)"
fi
echo ""

# Step 4: Analyze PCAP
echo "Step 4: Analyzing PCAP file..."
PCAP_PATH="$LAB_DIR/captures/$CAPTURE_FILE"
if [ -f "$PCAP_PATH" ]; then
    bash "$SCRIPT_DIR/analyze-pcap.sh" "$PCAP_PATH" "$LAB_DIR/findings"
    echo "✓ PCAP analysis complete"
else
    echo "⚠ Warning: PCAP file not found: $PCAP_PATH"
fi
echo ""

# Step 5: Extract findings from Kali container
echo "Step 5: Extracting findings from scan results..."
bash "$SCRIPT_DIR/extract-findings-from-kali.sh" "$TARGET_IP" 2>/dev/null || echo "  ⚠ Warning: Could not extract findings (may need to run manually)"
echo ""

# Step 6: Generate report
echo "Step 6: Generating external pentest report..."
bash "$SCRIPT_DIR/generate-external-report.sh" "$TARGET_IP"
if [ $? -eq 0 ]; then
    echo "✓ Report generation complete"
else
    echo "⚠ Warning: Report generation had issues"
fi
echo ""

echo "=========================================="
echo "External Pentest Workflow Complete!"
echo "=========================================="
echo ""
echo "Summary:"
echo "  - Target: $TARGET_IP"
echo "  - Capture file: $CAPTURE_FILE"
echo "  - Results: Check Kali container at /root/pentest-results/external_*"
echo "  - PCAP: $PCAP_PATH"
echo "  - Findings: $LAB_DIR/findings/external_${TARGET_IP//\./_}_*"
echo "  - Report: $LAB_DIR/reports/external_pentest_${TARGET_IP//\./_}_*.html"
echo ""
echo "Next steps:"
echo "  1. Review scan results:"
echo "     docker exec -it pentest-kali ls -la /root/pentest-results/external_*"
echo ""
echo "  2. View specific results:"
echo "     docker exec -it pentest-kali cat /root/pentest-results/external_port_scan_${TARGET_IP}_*.xml"
echo ""
echo "  3. Open the report:"
echo "     open $LAB_DIR/reports/external_pentest_${TARGET_IP//\./_}_*.html"
echo ""
echo "  4. Generate IDPS rules (via API or web interface):"
echo "     - Upload PCAP: POST http://localhost:8080/api/pcap/analyze"
echo "     - Generate rules: POST http://localhost:8080/api/rules/generate"
echo "     - Or use web UI: http://localhost:4200/pentest"
