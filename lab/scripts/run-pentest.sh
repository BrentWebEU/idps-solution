#!/bin/bash
# Main orchestration script for complete pentest workflow
# Coordinates traffic capture, pentesting, analysis, and rule generation

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LAB_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "=========================================="
echo "Penetration Test Orchestration"
echo "Timestamp: $TIMESTAMP"
echo "=========================================="
echo ""

# Check if lab is running
echo -e "${YELLOW}Checking lab environment...${NC}"
if ! docker ps | grep -q "pentest-kali"; then
    echo -e "${RED}Lab environment not running. Please start with: docker-compose up -d${NC}"
    exit 1
fi
echo -e "${GREEN}Lab environment is running${NC}"
echo ""

# Step 1: Start traffic capture
echo -e "${YELLOW}Step 1: Starting traffic capture...${NC}"
CAPTURE_FILE="capture_${TIMESTAMP}.pcap"
bash "$SCRIPT_DIR/capture.sh" start any "$CAPTURE_FILE"
if [ $? -eq 0 ]; then
    echo -e "${GREEN}Traffic capture started: $CAPTURE_FILE${NC}"
else
    echo -e "${RED}Failed to start traffic capture${NC}"
    exit 1
fi
echo ""

# Step 2: Run pentest
echo -e "${YELLOW}Step 2: Running penetration test...${NC}"
read -p "Run automated pentest? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    bash "$SCRIPT_DIR/automated-pentest.sh"
    PENTEST_TYPE="automated"
else
    echo "Skipping automated pentest. Run manual tests now."
    echo "When finished, press Enter to continue..."
    read
    PENTEST_TYPE="manual"
fi
echo ""

# Step 3: Stop capture
echo -e "${YELLOW}Step 3: Stopping traffic capture...${NC}"
bash "$SCRIPT_DIR/capture.sh" stop
if [ $? -eq 0 ]; then
    echo -e "${GREEN}Traffic capture stopped${NC}"
else
    echo -e "${YELLOW}Warning: Failed to stop capture (may not be running)${NC}"
fi
echo ""

# Step 4: Analyze PCAP
echo -e "${YELLOW}Step 4: Analyzing PCAP file...${NC}"
PCAP_PATH="$LAB_DIR/captures/$CAPTURE_FILE"
if [ -f "$PCAP_PATH" ]; then
    bash "$SCRIPT_DIR/analyze-pcap.sh" "$PCAP_PATH" "$LAB_DIR/findings"
    echo -e "${GREEN}PCAP analysis complete${NC}"
else
    echo -e "${YELLOW}Warning: PCAP file not found: $PCAP_PATH${NC}"
fi
echo ""

# Step 5: Generate findings report
echo -e "${YELLOW}Step 5: Generating findings report...${NC}"
bash "$SCRIPT_DIR/generate-report.sh" "$TIMESTAMP" "$PENTEST_TYPE"
echo -e "${GREEN}Report generation complete${NC}"
echo ""

# Step 6: Generate IDPS rules
echo -e "${YELLOW}Step 6: Generating IDPS rules...${NC}"
read -p "Generate IDPS rules from findings? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "To generate rules, use the API endpoint:"
    echo "  POST http://localhost:8080/api/rules/generate"
    echo "  with finding data as JSON payload"
    echo ""
    echo "Or use the Python framework reporter:"
    echo "  python3 $SCRIPT_DIR/pentest-framework/reporter.py $LAB_DIR/findings"
fi
echo ""

# Step 7: Activate rules (optional)
echo -e "${YELLOW}Step 7: Rule activation (optional)...${NC}"
read -p "Activate generated rules in Suricata? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "To activate rules, use the API endpoint:"
    echo "  POST http://localhost:8080/api/rules/activate"
    echo "  with {\"rule_file\": \"rule_name.rules\"}"
    echo ""
    echo "Note: Suricata may need to be restarted to load new rules"
fi
echo ""

echo "=========================================="
echo -e "${GREEN}Penetration test workflow complete!${NC}"
echo "=========================================="
echo ""
echo "Summary:"
echo "  - Capture file: $CAPTURE_FILE"
echo "  - Pentest type: $PENTEST_TYPE"
echo "  - Findings: $LAB_DIR/findings/"
echo "  - Reports: $LAB_DIR/reports/"
echo ""
echo "Next steps:"
echo "  1. Review findings in: $LAB_DIR/findings/"
echo "  2. Review report in: $LAB_DIR/reports/"
echo "  3. Generate and activate IDPS rules via API"
echo "  4. Test rules against new traffic"
